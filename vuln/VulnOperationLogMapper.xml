<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.starso.job.modules.vuln.mapper.VulnOperationLogMapper">
    <resultMap id="BaseResultMap" type="com.starso.job.modules.vuln.domain.VulnOperationLog" >
        <id column="id" jdbcType="VARCHAR" property="id" />
        <result column="vuln_id" jdbcType="VARCHAR" property="vulnId" />
        <result column="url_id" jdbcType="VARCHAR" property="urlId" />
        <result column="retest_id" jdbcType="VARCHAR" property="retestId" />
        <result column="same_vuln_id" jdbcType="VARCHAR" property="sameVulnId" />
        <result column="remark" jdbcType="VARCHAR" property="remark" />
        <result column="new_msg" jdbcType="VARCHAR" property="newMsg" />
        <result column="old_msg" jdbcType="VARCHAR" property="oldMsg" />
        <result column="type" jdbcType="CHAR" property="type" />
        <result column="operationer" jdbcType="VARCHAR" property="operationer" />
        <result column="operation_time" jdbcType="TIMESTAMP" property="operationTime" />
    </resultMap>
    <sql id="Base_Column_List" >
        ol.id, ol.vuln_id, ol.url_id, ol.remark, ol.new_msg, ol.old_msg, ol.type, ol.operationer, ol.operation_time,
        date_format(ol.operation_time,'%Y-%m-%d %T') operationTimeStr,ol.retest_id,ol.same_vuln_id
    </sql>

    <select id="selectVulnOperationLog" parameterType="com.starso.job.modules.vuln.domain.VulnOperationLog" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />,
        v.vuln_code vulnCode,
        v.title name ,
        u.`nick_name` operationerName,
        u.photo_id photoId
        from
        vuln_operation_log ol
        left join vuln_business v on ol.vuln_id = v.id
        left join sys_user u on ol.operationer = u.user_id
        where
        1=1
        and (
        ol.vuln_id = #{vulnId,jdbcType=VARCHAR}
        <if test="recurrentVulnId!=null and recurrentVulnId!=''">
            or v.recurrent_vuln_id = #{recurrentVulnId,jdbcType=VARCHAR}
            or v.id = #{recurrentVulnId,jdbcType=VARCHAR}
        </if>
        )
        <if test="operationTimeStr !=null and operationTimeStr !=''">
            and DATE_FORMAT(ol.operation_time,'%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> #{operationTimeStr}
        </if>
        order by ol.operation_time desc
    </select>
</mapper>