<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.starso.job.modules.dataTimer.mapper.SspEventTaskMapper">
  <resultMap id="BaseResultMap" type="com.starso.job.modules.event.domain.EventTask">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="event_id" jdbcType="VARCHAR" property="eventId" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="task_group" jdbcType="VARCHAR" property="taskGroup" />
    <result column="assignee" jdbcType="VARCHAR" property="assignee" />
    <result column="assignee_role" jdbcType="VARCHAR" property="assigneeRole" />
    <result column="audit_status" jdbcType="CHAR" property="auditStatus" />
    <result column="audit_id" jdbcType="VARCHAR" property="auditId" />
    <result column="status" jdbcType="CHAR" property="status" />
    <result column="is_close" jdbcType="CHAR" property="isClose" />
    <result column="create_by" jdbcType="VARCHAR" property="createBy" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
    <result column="first_submit_time" jdbcType="TIMESTAMP" property="firstSubmitTime" />
    <result column="last_submit_time" jdbcType="TIMESTAMP" property="lastSubmitTime" />
    <result column="spot_check_status" jdbcType="CHAR" property="spotCheckStatus" />
    <result column="is_manage_task" jdbcType="CHAR" property="isManageTask" />
    <result column="task_type" jdbcType="VARCHAR" property="taskType" />
    <result column="is_alert_task" jdbcType="VARCHAR" property="isAlertTask" />
    <result column="is_manage_task" jdbcType="VARCHAR" property="isManageTask" />
    <result column="start_notice_type" jdbcType="CHAR" property="startNoticeType" />
    <result column="auditCode" jdbcType="VARCHAR" property="auditCode" />
    <result column="auditTime" jdbcType="TIMESTAMP" property="auditTime" />
  </resultMap>
  
  <sql id="Base_Column_List">
    et.id, et.event_id, et.title, et.task_group, et.audit_status, et.status, et.assignee_role,et.status,
    et.create_time, et.start_time, et.first_submit_time, et.spot_check_status,et.is_close,et.last_submit_time,
    et.spot_check_status,et.task_type,et.is_alert_task,et.is_manage_task,et.start_notice_type,et.audit_id
  </sql>
  
  
  <select id="selectSspEventTask" resultMap="BaseResultMap" parameterType="com.starso.job.modules.event.domain.EventTask">
  	SELECT DISTINCT <include refid="Base_Column_List" />,su.user_name assignee,s_u.user_name create_by,sr.user_name auditCode,
  	eta.audit_time auditTime
  	FROM event_task et
  	LEFT JOIN event_task_audit eta ON et.audit_id = eta.id
  	LEFT JOIN sys_user sr ON eta.audit_id = sr.user_id AND sr.status = '1'
	LEFT JOIN sys_user su ON et.assignee = su.user_id AND su.`status` = '1'
	LEFT JOIN sys_user s_u ON et.create_by = s_u.user_id AND s_u.`status` = '1'
	WHERE et.`status` = '1'
	<if test="updateTime != null">
        AND GREATEST(et.update_time,ifnull(et.last_submit_time,et.update_time)) >= #{createTime, jdbcType=TIMESTAMP}
    </if>
  </select>

  <select id="selectStereotypeCount" resultType="int" parameterType="com.starso.job.modules.event.domain.Event">
  	SELECT COUNT(DISTINCT e.id) FROM `event` e
	INNER JOIN event_template et ON e.template_id = et.id AND et.`status` = '1' AND et.type = '1'
	INNER JOIN event_task task ON e.id = task.event_id AND task.`status` = '1' AND task.audit_status = '3'
	WHERE e.`status` = '1' AND e.create_time <![CDATA[>=]]> #{beginTimeStr} AND e.create_time <![CDATA[<=]]> #{endTimeStr}
  </select>

  <select id="selectEventCount" resultType="int" parameterType="com.starso.job.modules.event.domain.Event">
  	SELECT COUNT(distinct e.id) FROM `event` e INNER JOIN event_task task ON e.id = task.event_id AND task.`status` = '1' AND task.audit_status = '3'
  	WHERE e.`status` = '1' AND e.create_time <![CDATA[>=]]> #{beginTimeStr} AND e.create_time <![CDATA[<=]]> #{endTimeStr}
  </select>
</mapper>